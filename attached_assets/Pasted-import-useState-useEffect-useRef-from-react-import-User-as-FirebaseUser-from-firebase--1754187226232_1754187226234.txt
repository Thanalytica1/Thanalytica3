import { useState, useEffect, useRef } from "react";
import { User as FirebaseUser } from "firebase/auth";
import { auth, handleAuthRedirect } from "@/lib/firebase";
import { onAuthStateChanged } from "firebase/auth";
import { useUser, useCreateUser } from "./use-user";
import type { User } from "@shared/schema";

export function useAuth() {
  const [firebaseUser, setFirebaseUser] = useState<FirebaseUser | null>(null);
  const [loading, setLoading] = useState(true);
  const isMountedRef = useRef(true);
  
  const { data: dbUser, isLoading: userLoading, refetch: refetchUser } = useUser(firebaseUser?.uid || "");
  const createUser = useCreateUser();

  useEffect(() => {
    isMountedRef.current = true;
    
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (!isMountedRef.current) return;
      
      setFirebaseUser(user);
      
      if (user) {
        // Use a more robust approach to ensure user exists in database
        try {
          // Small delay to prevent race conditions
          await new Promise(resolve => setTimeout(resolve, 100));
          
          if (!isMountedRef.current) return;
          
          const userResponse = await refetchUser();
          
          if (!isMountedRef.current) return;
          
          // Only create user if we don't have one and we're not already creating
          if (!userResponse.data && !createUser.isPending) {
            createUser.mutate({
              firebaseUid: user.uid,
              email: user.email!,
              displayName: user.displayName,
              photoURL: user.photoURL,
            });
          }
        } catch (error) {
          // Ignore AbortError and other race condition errors
          if (error instanceof Error && !error.message.includes('aborted')) {
            console.error("Auth error:", error);
          }
        }
      }
      
      if (isMountedRef.current) {
        setLoading(false);
      }
    });

    // Handle redirect result on page load
    handleAuthRedirect()
      .then((result) => {
        if (isMountedRef.current && result?.user) {
          setFirebaseUser(result.user);
        }
      })
      .catch((error) => {
        if (isMountedRef.current) {
          console.error("Auth redirect error:", error);
        }
      })
      .finally(() => {
        if (isMountedRef.current) {
          setLoading(false);
        }
      });

    // Cleanup function
    return () => {
      isMountedRef.current = false;
      unsubscribe();
    };
  }, [refetchUser, createUser]);

  const isLoading = loading || userLoading || createUser.isPending;
  
  return { 
    firebaseUser, 
    user: dbUser as User | undefined, 
    loading: isLoading 
  };
}